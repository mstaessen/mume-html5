(function(i){i.extend({indexedDB:function(p,e){var j=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,v=window.IDBKeyRange||window.webkitIDBKeyRange,t=window.IDBTransaction||window.webkitIDBTransaction;if(e){"number"===typeof e&&(e={version:e});var q=e.version;if(e.schema&&!q){var r=-1;for(key in e.schema)r=r>key?r:key;q=e.version||r}}var g={request:function(a,c){return i.Deferred(function(d){try{var b="function"===typeof a?a(c):a;b.onsuccess=function(a){d.resolveWith(b,
[b.result,a])};b.onerror=function(a){d.rejectWith(b,[b.error,a])};"undefined"!==typeof b.onblocked&&null===b.onblocked&&(b.onblocked=function(a){try{var c=b.result}catch(h){c=null}d.notifyWith(b,[c,a])});"undefined"!==typeof b.onupgradeneeded&&null===b.onupgradeneeded&&(b.onupgradeneeded=function(a){d.notifyWith(b,[b.result,a])})}catch(h){h.name="exception",d.rejectWith(b,["exception",h])}})},transaction:function(a){return{objectStore:function(c){try{return g.objectStore(a.objectStore(c))}catch(d){return a.readyState!==
a.DONE&&a.abort(),g.objectStore(null)}},createObjectStore:function(c,d){try{return g.objectStore(a.db.createObjectStore(c,d))}catch(b){a.readyState!==a.DONE&&a.abort()}},deleteObjectStore:function(c){try{a.db.deleteObjectStore(c)}catch(d){a.readyState!==a.DONE&&a.abort()}},abort:function(){a.abort()}}},objectStore:function(a){for(var c={},d="add put get delete clear count".split(" "),b=0;b<d.length;b++)c[d[b]]=function(b){return function(){return g.request(function(c){return a[b].apply(a,c)},arguments)}}(d[b]);
c.each=function(b,c,d){return g.cursor(function(){return d?a.openCursor(g.range(c),d):a.openCursor(g.range(c))},b)};c.index=function(b){return g.index(function(){return a.index(b)})};c.createIndex=function(b,c,d){2===arguments.length&&"string"===typeof c&&(d=arguments[1],c=null);d||(d=b);return g.index(function(){return a.createIndex(d,b,c)})};c.deleteIndex=function(b){return a.deleteIndex(b)};return c},range:function(a){return i.isArray(a)?1===a.length?v.only(a[0]):v.bound(a[0],a[1],a[2]||!0,a[3]||
!0):"undefined"===typeof a?null:a},cursor:function(a,c){return i.Deferred(function(d){try{var b="function"===typeof a?a():a;b.onsuccess=function(a){if(b.result){var h={"delete":function(){return g.request(function(){return b.result["delete"]()})},update:function(a){return g.request(function(){return b.result.update(a)})},next:function(b){this.data=b},key:b.result.key,value:b.result.value};d.notifyWith(b,[h,a]);var k=c.apply(b,[h]);try{if(!1===k)d.resolveWith(b,[null,a]);else if("number"===typeof k)b.result.advance.apply(b.result,
[k]);else if(h.data)b.result["continue"].apply(b.result,[h.data]);else b.result["continue"]()}catch(e){d.rejectWith(b,[b.result,e])}}else d.resolveWith(b,[null,a])};b.onerror=function(a){d.rejectWith(b,[b.result,a])}}catch(h){h.type="exception",d.rejectWith(b,[null,h])}})},index:function(a){try{var c="function"===typeof a?a():a}catch(d){c=null}return{each:function(b,a,d){return g.cursor(function(){return d?c.openCursor(g.range(a),d):c.openCursor(g.range(a))},b)},eachKey:function(a,d,f){return g.cursor(function(){return f?
c.openKeyCursor(g.range(d),f):c.openKeyCursor(g.range(d))},a)}}}},u=function(a,c){function d(a){var a=a||h,b;for(b in a)"undefined"===typeof f[b]&&(f[b]=a[b])}function b(a,b,d,c){"function"===typeof b[a]&&b[a].apply(b,d);"function"===typeof c&&c()}var h=c?j.open(a,c):j.open(a),f=new function(){this.onsuccess=this.onerror=this.onblocked=this.onupgradeneeded=null};h.onsuccess=function(e){d();var g=h.result;if("function"===typeof g.setVersion){var n=parseInt(g.version||0,10),s="undefined"===typeof c?
0===n?1:n:parseInt(c,10);if(n<s){var l=g.setVersion(s);l.onsuccess=function(c){f.transaction=l.result;var h=new Event("upgradeneeded");h.oldVersion=n;h.newVersion=s;for(key in c)"type"!==key&&(h[key]=c[key]);b("onupgradeneeded",f,[h]);l.result.db.close();var e=j.open(a);delete f.transaction;delete f.result;e.onsuccess=function(a){d(e);b("onsuccess",f,[a],function(){e.result.close()});e.result.close()};e.onerror=function(a){d(e);b("onerror",f,[a],function(){e.result.close()})};e.onblocked=function(a){d(e);
b("onblocked",f,[a],function(){e.result.close()})}};l.onerror=function(){b("onerror",f,[e]);l.result.close()};l.onblocked=function(a){b("onblocked",f,[a])}}else n===s?b("onsuccess",f,[e]):b("onerror",f,[e]),g.close()}else b("onsuccess",f,[e])};h.onerror=function(a){d();b("onerror",f,[a])};h.onblocked=function(a){d();b("onblocked",f,[a])};h.onupgradeneeded=function(a){d();if("function"===typeof f.onupgradeneeded)f.onupgradeneeded(a)};return f},m=g.request(function(){return q?u(p,q):u(p)});m.then(function(a){a.onversionchange=
function(){(!e||!(e.onversionchange&&!1!==e.onversionchange()))&&a.close()}},function(){},function(a,c){if(c&&"upgradeneeded"===c.type){if(e&&e.schema)for(var d=c.oldVersion+1;d<=c.newVersion;d++)"function"===typeof e.schema[d]&&e.schema[d].call(this,g.transaction(this.transaction));e&&"function"===typeof e.upgrade&&e.upgrade.call(this,g.transaction(this.transaction))}});return i.extend(m,{cmp:function(a,c){return j.cmp(a,c)},deleteDatabase:function(){return i.Deferred(function(a){m.then(function(c){c.close();
g.request(function(){return j.deleteDatabase(p)}).then(function(c,b){a.resolveWith(this,[c,b])},function(c,b){a.rejectWith(this,[c,b])},function(c,b){a.notifyWith(this,[c,b])})},function(c,d){a.rejectWith(this,[c,d])},function(c,d){a.notifyWith(this,[c,d])})})},transaction:function(a,c){!i.isArray(a)&&(a=[a]);c=c||t.READ_WRITE;return i.Deferred(function(d){m.then(function(b){try{var e=b.transaction(a,c);e.onabort=e.onerror=function(a){d.rejectWith(e,[a])};e.oncomplete=function(a){d.resolveWith(e,
[a])}}catch(f){f.type="exception";d.rejectWith(this,[f]);return}try{d.notifyWith(e,[g.transaction(e)])}catch(i){i.type="exception",d.rejectWith(this,[i])}},function(a,c){d.rejectWith(this,[c,a])},function(){})})},objectStore:function(a,c){function d(b){return i.Deferred(function(d){function f(b,c){try{c(b.objectStore(a)).then(function(a,b){d.resolveWith(this,[a,b])},function(a,b){d.rejectWith(this,[a,b])})}catch(e){e.name="exception",d.rejectWith(b,[e,e])}}h.transaction(a,"number"===typeof c?c:t.READ_WRITE).then(function(){},
function(i,j){if(i.code===i.NOT_FOUND_ERR&&(!0===c||"object"===typeof c)){var k=this.result;k.close();m=g.request(function(){return u(p,(parseInt(k.version,10)||1)+1)});m.then(function(g){g.onversionchange=function(){(!e||!(e.onversionchange&&!1!==e.onversionchange()))&&g.close()};h.transaction(a,"number"===typeof c?c:t.READ_WRITE).then(function(){},function(a,b){d.rejectWith(this,[a,b])},function(a){f(a,b)})},function(a,b){d.rejectWith(this,[a,b])},function(b,e){if("upgradeneeded"===e.type)try{b.createObjectStore(a,
!0===c?{autoIncrement:!0}:c)}catch(f){d.rejectWith(this,[f,e])}})}else d.rejectWith(this,[i,j])},function(a){f(a,b)})})}function b(a,b,c){return d(function(d){d=d.index(b);return d[a].apply(d[a],c)})}for(var h=this,f={},j="add delete get put clear count each".split(" "),k=0;k<j.length;k++)f[j[k]]=function(a){return function(){var b=arguments;return d(function(c){return c[a].apply(c,b)})}}(j[k]);f.index=function(a){return{each:function(c,d,e){return b("each",a,[c,d,e])},eachKey:function(c,d,e){return b("eachKey",
a,[c,d,e])}}};return f}})}});i.indexedDB.IDBCursor=window.IDBCursor||window.webkitIDBCursor;i.indexedDB.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction})(jQuery);